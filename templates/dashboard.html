{% extends "base.html" %}

{% block content %}
<div class="sticky-top bg-white py-3 border-bottom shadow-sm mb-4" style="top: 0; z-index: 1020; margin-left: -1rem; margin-right: -1rem; padding-left: 1rem; padding-right: 1rem;">
    <div class="d-flex justify-content-between align-items-center">
        <h3 class="mb-0">Server: <span class="text-primary small">{{ server_name }}</span></h3>
        <div>
            <button id="bulkMoveBtn" class="btn btn-primary d-none me-2">Move Selected</button>
            <button id="bulkDeleteBtn" class="btn btn-danger d-none me-2">Delete Selected</button>
            <button id="scanBtn" class="btn btn-success">Scan for Duplicates</button>
        </div>
    </div>
</div>

<div id="results"></div>

<div id="loading" class="text-center d-none my-4">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2" id="loadingText">Scanning libraries...</p>
</div>

<div id="noMoreResults" class="text-center d-none my-4 text-muted">
    <hr>
    <p>No more duplicates found.</p>
</div>

<!-- Move Modal -->
<div class="modal fade" id="moveModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="moveModalTitle">Move File(s)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="moveSourceInfo" class="mb-3 small"></div>
        <div class="mb-3">
            <label class="form-label">Select Destination Folder:</label>
            <div id="targetFolderList" class="list-group">
                <!-- Target folders will be loaded here -->
            </div>
            <div id="noFoldersAlert" class="alert alert-warning d-none">
                No target folders configured. Please add them in <a href="/settings">Settings</a>.
            </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmMoveBtn" disabled>Confirm Move</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Single Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to <strong>permanently delete</strong> this file?</p>
        <div class="alert alert-danger text-break font-monospace small" id="modalFilePath"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete File</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Bulk Delete Modal -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Bulk Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to <strong>permanently delete</strong> <span id="bulkDeleteCount" class="fw-bold">0</span> files?</p>
        <div class="alert alert-danger small">This will include all files marked as "sample". This action cannot be undone.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmBulkDeleteBtn">Delete All Selected</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let offset = 0;
const limit = 20;
let isLoading = false;
let hasMore = true;
let scanResults = [];
let fileToDelete = null;
let rowToDelete = null;
let itemIdxToDelete = null;

// Move state
let fileToMove = null;
let rowToMove = null;
let itemIdxToMove = null;
let selectedFilesToMove = [];
let selectedRowsToMove = [];
let selectedItemIdxsToMove = new Set();
let selectedTargetDir = null;

$(document).ready(function() {
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    const bulkDeleteModal = new bootstrap.Modal(document.getElementById('bulkDeleteModal'));
    const moveModal = new bootstrap.Modal(document.getElementById('moveModal'));

    $('#scanBtn').click(function() {
        resetScan();
        loadMore();
    });

    $(window).scroll(function() {
        if ($(window).scrollTop() + $(window).height() > $(document).height() - 200) {
            if (!isLoading && hasMore && scanResults.length > 0) {
                loadMore();
            }
        }
    });

    function resetScan() {
        offset = 0;
        hasMore = true;
        scanResults = [];
        $('#results').empty();
        $('#noMoreResults').addClass('d-none');
        $('#bulkDeleteBtn').addClass('d-none');
        $('#bulkMoveBtn').addClass('d-none');
        $('#scanBtn').prop('disabled', true);
    }

    function loadMore() {
        if (isLoading || !hasMore) return;
        
        isLoading = true;
        $('#loading').removeClass('d-none');
        $('#loadingText').text(offset === 0 ? "Initial Scan..." : "Loading more results...");

        $.ajax({
            url: `/scan?offset=${offset}&limit=${limit}`,
            method: 'GET',
            success: function(data) {
                isLoading = false;
                $('#loading').addClass('d-none');
                $('#scanBtn').prop('disabled', false);
                
                if (data.items.length === 0 && offset === 0) {
                    $('#results').html('<div class="alert alert-info">No duplicates found!</div>');
                    hasMore = false;
                    return;
                }

                const startIdx = scanResults.length;
                scanResults = scanResults.concat(data.items);
                hasMore = data.has_more;
                offset += data.items.length;

                renderItems(data.items, startIdx);

                if (!hasMore && scanResults.length > 0) {
                    $('#noMoreResults').removeClass('d-none');
                }
            },
            error: function(err) {
                isLoading = false;
                $('#loading').addClass('d-none');
                $('#scanBtn').prop('disabled', false);
                alert('Error scanning: ' + (err.responseJSON ? err.responseJSON.error : 'Unknown error'));
            }
        });
    }

    function loadTargetFolders() {
        $('#targetFolderList').empty();
        $('#noFoldersAlert').addClass('d-none');
        $('#confirmMoveBtn').prop('disabled', true);
        selectedTargetDir = null;

        // Load manual folders
        const manualFoldersPromise = $.ajax({ url: '/folders', method: 'GET' });
        // Load Plex library folders
        const plexFoldersPromise = $.ajax({ url: '/plex_folders', method: 'GET' });

        Promise.all([manualFoldersPromise, plexFoldersPromise]).then(results => {
            const manual = results[0].folders || [];
            const plex = results[1].folders || [];
            const allFolders = [];

            if (manual.length > 0) {
                $('#targetFolderList').append('<div class="list-group-item bg-light fw-bold py-1 small">Manual Folders</div>');
                manual.forEach(f => {
                    const item = createFolderItem(f);
                    $('#targetFolderList').append(item);
                });
            }

            if (plex.length > 0) {
                $('#targetFolderList').append('<div class="list-group-item bg-light fw-bold py-1 small">Plex Library Folders</div>');
                plex.forEach(f => {
                    const item = createFolderItem(f);
                    $('#targetFolderList').append(item);
                });
            }

            if (manual.length === 0 && plex.length === 0) {
                $('#noFoldersAlert').removeClass('d-none');
            }
        }).catch(err => {
            alert('Error loading folders: ' + (err.responseJSON ? err.responseJSON.error : 'Unknown error'));
        });
    }

    function createFolderItem(folder) {
        const item = $(`<a href="#" class="list-group-item list-group-item-action font-monospace small text-break">${folder}</a>`);
        item.click(function(e) {
            e.preventDefault();
            $('.list-group-item-action').removeClass('active');
            $(this).addClass('active');
            selectedTargetDir = folder;
            $('#confirmMoveBtn').prop('disabled', false);
            
            // Show preview of final path
            if (selectedFilesToMove.length === 1) {
                const fileName = selectedFilesToMove[0].split('/').pop();
                $('#moveSourceInfo').html(`
                    <div class="mb-2">Moving: <span class="font-monospace text-primary text-break">${selectedFilesToMove[0]}</span></div>
                    <div class="fw-bold text-success">Destination: <span class="font-monospace text-break">${selectedTargetDir}/${fileName}</span></div>
                `);
            } else {
                $('#moveSourceInfo').html(`
                    <div class="mb-2">Moving <span class="badge bg-primary">${selectedFilesToMove.length}</span> files to:</div>
                    <div class="fw-bold text-success font-monospace text-break">${selectedTargetDir}/</div>
                `);
            }
        });
        return item;
    }

    function renderItems(items, globalStartIndex) {
        let html = '';
        items.forEach((item, localIndex) => {
            const itemIndex = globalStartIndex + localIndex;
            html += `
            <div class="card mb-3 item-card" id="item-card-${itemIndex}" data-item-idx="${itemIndex}">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 text-truncate" title="${item.title}">${item.title} <span class="badge bg-secondary ms-2">${item.type}</span></h6>
                    <button class="btn btn-outline-secondary btn-sm py-0 select-all-btn" data-item-idx="${itemIndex}">Select All But One</button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0 small">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 40px"></th>
                                    <th>Res</th>
                                    <th>Codec</th>
                                    <th>Languages</th>
                                    <th>Size</th>
                                    <th style="width: 40%">Path</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody class="file-list">
            `;
            
            item.files.forEach((file, fileIndex) => {
                const uniqueId = `file-${itemIndex}-${fileIndex}`;
                const isSample = file.file.toLowerCase().includes('sample');
                const checkedAttr = isSample ? 'checked' : '';
                const rowClass = isSample ? 'table-warning file-row' : 'file-row';

                // Format Languages
                let langHtml = '';
                if (file.languages && file.languages.length > 0) {
                    file.languages.forEach(lang => {
                        langHtml += `<span class="badge bg-dark me-1">${lang}</span>`;
                    });
                } else {
                    langHtml = '<span class="text-muted small">None</span>';
                }

                html += `
                    <tr id="${uniqueId}" class="${rowClass}">
                        <td><input type="checkbox" class="file-checkbox" data-item-idx="${itemIndex}" data-file-idx="${fileIndex}" data-row-id="${uniqueId}" ${checkedAttr}></td>
                        <td><span class="badge bg-info text-dark">${file.resolution}</span></td>
                        <td>${file.codec}</td>
                        <td>${langHtml}</td>
                        <td>${formatBytes(file.size)}</td>
                        <td class="text-muted text-break font-monospace" style="font-size: 0.85rem;">
                            ${isSample ? '<span class="badge bg-danger me-1">SAMPLE</span>' : ''}
                            ${file.file}
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-outline-primary btn-sm py-0 px-2 move-trigger" 
                                    data-item-idx="${itemIndex}" 
                                    data-file-idx="${fileIndex}"
                                    data-row-id="${uniqueId}">
                                    Move
                                </button>
                                <button class="btn btn-danger btn-sm py-0 px-2 delete-trigger" 
                                    data-item-idx="${itemIndex}" 
                                    data-file-idx="${fileIndex}"
                                    data-row-id="${uniqueId}">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        });

        $('#results').append(html);
        updateBulkBtns();

        $('.move-trigger').off('click').on('click', function() {
            const iIdx = $(this).data('item-idx');
            const fIdx = $(this).data('file-idx');
            rowToMove = $(this).data('row-id');
            itemIdxToMove = iIdx;
            fileToMove = scanResults[iIdx].files[fIdx].file;
            selectedFilesToMove = [fileToMove];
            selectedRowsToMove = [rowToMove];
            selectedItemIdxsToMove = new Set([itemIdxToMove]);
            
            $('#moveModalTitle').text('Move Single File');
            $('#moveSourceInfo').html(`Moving: <span class="font-monospace text-primary text-break">${fileToMove}</span>`);
            loadTargetFolders();
            moveModal.show();
        });

        $('.delete-trigger').off('click').on('click', function() {
            const iIdx = $(this).data('item-idx');
            const fIdx = $(this).data('file-idx');
            rowToDelete = $(this).data('row-id');
            itemIdxToDelete = iIdx;
            fileToDelete = scanResults[iIdx].files[fIdx].file;
            
            $('#modalFilePath').text(fileToDelete);
            deleteModal.show();
        });

        $('.select-all-btn').off('click').on('click', function() {
            const iIdx = $(this).data('item-idx');
            const checkboxes = $(`.file-checkbox[data-item-idx="${iIdx}"]`);
            checkboxes.prop('checked', true);
            checkboxes.last().prop('checked', false);
            updateBulkBtns();
        });

        $('.file-checkbox').off('change').on('change', function() {
            updateBulkBtns();
        });

        // Make the entire row clickable to toggle the checkbox
        $('.file-row').off('click').on('click', function(e) {
            // Ignore if we clicked the checkbox itself or the action buttons
            if ($(e.target).is('input, button, .btn, .btn-group')) return;
            
            const checkbox = $(this).find('.file-checkbox');
            checkbox.prop('checked', !checkbox.prop('checked'));
            updateBulkBtns();
        });
    }

    function updateBulkBtns() {
        const count = $('.file-checkbox:checked').length;
        if (count > 0) {
            $('#bulkDeleteBtn').removeClass('d-none').text(`Delete Selected (${count})`);
            $('#bulkMoveBtn').removeClass('d-none').text(`Move Selected (${count})`);
        } else {
            $('#bulkDeleteBtn').addClass('d-none');
            $('#bulkMoveBtn').addClass('d-none');
        }
    }

    $('#bulkMoveBtn').click(function() {
        const selectedCheckboxes = $('.file-checkbox:checked');
        selectedFilesToMove = [];
        selectedRowsToMove = [];
        selectedItemIdxsToMove = new Set();

        selectedCheckboxes.each(function() {
            const iIdx = $(this).data('item-idx');
            const fIdx = $(this).data('file-idx');
            selectedFilesToMove.push(scanResults[iIdx].files[fIdx].file);
            selectedRowsToMove.push($(this).data('row-id'));
            selectedItemIdxsToMove.add(iIdx);
        });

        $('#moveModalTitle').text(`Move ${selectedFilesToMove.length} Files`);
        $('#moveSourceInfo').text(`Multiple files selected for move.`);
        loadTargetFolders();
        moveModal.show();
    });

    $('#confirmMoveBtn').click(function() {
        if (!selectedTargetDir || selectedFilesToMove.length === 0) return;
        const btn = $(this);
        btn.prop('disabled', true).text('Moving...');

        const isBulk = selectedFilesToMove.length > 1;
        const endpoint = isBulk ? '/move_bulk' : '/move';
        const data = isBulk 
            ? { file_paths: selectedFilesToMove, target_dir: selectedTargetDir }
            : { file_path: selectedFilesToMove[0], target_dir: selectedTargetDir };

        $.ajax({
            url: endpoint,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                moveModal.hide();
                btn.prop('disabled', false).text('Confirm Move');
                
                selectedRowsToMove.forEach(rowId => {
                    $('#' + rowId).fadeOut(function() { $(this).remove(); });
                });

                setTimeout(() => {
                    selectedItemIdxsToMove.forEach(iIdx => {
                        const card = $('#item-card-' + iIdx);
                        if (card.find('.file-row:visible').length <= 1) {
                            card.addClass('border-success');
                            setTimeout(() => { card.fadeOut(function() { $(this).remove(); }); }, 500);
                        }
                    });
                    updateBulkBtns();
                }, 600);
            },
            error: function(err) {
                alert('Error moving file(s): ' + (err.responseJSON ? err.responseJSON.error : 'Unknown error'));
                btn.prop('disabled', false).text('Confirm Move');
            }
        });
    });

    $('#bulkDeleteBtn').click(function() {
        const count = $('.file-checkbox:checked').length;
        $('#bulkDeleteCount').text(count);
        bulkDeleteModal.show();
    });

    $('#confirmBulkDeleteBtn').click(function() {
        const selectedCheckboxes = $('.file-checkbox:checked');
        const filePaths = [];
        const rowsToRemove = [];
        const affectedItemIndices = new Set();

        selectedCheckboxes.each(function() {
            const iIdx = $(this).data('item-idx');
            const fIdx = $(this).data('file-idx');
            filePaths.push(scanResults[iIdx].files[fIdx].file);
            rowsToRemove.push($(this).data('row-id'));
            affectedItemIndices.add(iIdx);
        });

        const btn = $(this);
        btn.prop('disabled', true).text('Deleting...');

        $.ajax({
            url: '/delete_bulk',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ file_paths: filePaths }),
            success: function(response) {
                bulkDeleteModal.hide();
                btn.prop('disabled', false).text('Delete All Selected');
                
                rowsToRemove.forEach(rowId => {
                    $('#' + rowId).remove();
                });

                affectedItemIndices.forEach(iIdx => {
                    const card = $('#item-card-' + iIdx);
                    const remainingFiles = card.find('.file-row').length;
                    if (remainingFiles <= 1) {
                        card.addClass('border-success');
                        setTimeout(() => {
                            card.fadeOut(function() { $(this).remove(); });
                        }, 500);
                    }
                });

                updateBulkBtns();
            },
            error: function(err) {
                alert('Error in bulk delete: ' + (err.responseJSON ? err.responseJSON.error : 'Unknown error'));
                btn.prop('disabled', false).text('Delete All Selected');
                bulkDeleteModal.hide();
            }
        });
    });

    $('#confirmDeleteBtn').click(function() {
        if (!fileToDelete) return;
        const btn = $(this);
        btn.prop('disabled', true).text('Deleting...');

        $.ajax({
            url: '/delete',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ file_path: fileToDelete }),
            success: function(response) {
                $('#' + rowToDelete).fadeOut(function() { 
                    $(this).remove(); 
                    const card = $('#item-card-' + itemIdxToDelete);
                    if (card.find('.file-row').length <= 1) {
                        card.addClass('border-success');
                        setTimeout(() => { card.fadeOut(function() { $(this).remove(); }); }, 500);
                    }
                });
                deleteModal.hide();
                fileToDelete = null;
                btn.prop('disabled', false).text('Delete File');
                updateBulkBtns();
            },
            error: function(err) {
                alert('Error deleting file: ' + (err.responseJSON ? err.responseJSON.error : 'Unknown error'));
                btn.prop('disabled', false).text('Delete File');
                deleteModal.hide();
            }
        });
    });

    function formatBytes(bytes, decimals = 2) {
        if (!+bytes) return '0 B';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
    }
});
</script>
{% endblock %}
